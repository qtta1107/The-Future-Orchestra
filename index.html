<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Future Orchestra - Opera Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pinyon+Script&family=Montserrat:wght@200;300;400;500;600;700;800;900&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --gold: #ffd700;
            --gold-dim: #d4af37;
            --velvet: #4a0404; /* Darker, richer red */
            --velvet-highlight: #7a0a0a;
            --velvet-shadow: #2a0000;
            --dark-bg: #050505;
            --glass: rgba(20, 20, 20, 0.6);
            --color-R: #ef4444; --color-I: #3b82f6; --color-A: #ec4899;
            --color-S: #10b981; --color-E: #8b5cf6; --color-C: #f59e0b;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--dark-bg); 
            color: #e5e5e5; 
            margin: 0; padding: 0; user-select: none; perspective: 1500px;
            overflow-x: hidden; overflow-y: hidden; 
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }

        .royal-font { font-family: 'Pinyon Script', cursive; }

        /* --- KEYFRAMES --- */
        @keyframes popIn {
            0% { opacity: 0; transform: translateY(100px) scale(0.5); }
            60% { opacity: 1; transform: translateY(-20px) scale(1.05); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        @keyframes neonPulse {
            0% { box-shadow: 0 0 10px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--active-color); }
            50% { box-shadow: 0 0 30px var(--glow-color), 0 0 50px var(--glow-color), inset 0 0 10px var(--active-color); border-color: #fff; }
            100% { box-shadow: 0 0 10px var(--glow-color), inset 0 0 5px var(--glow-color); border-color: var(--active-color); }
        }

        @keyframes shineSweep {
            0% { left: -100%; opacity: 0; }
            50% { opacity: 0.5; }
            100% { left: 200%; opacity: 0; }
        }

        @keyframes clickBounce {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1.02); }
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- ENVIRONMENT --- */
        .stage-container { position: fixed; inset: 0; z-index: 0; background: #000; }
        .stage-floor { 
            position: absolute; bottom: -25%; left: -10%; width: 120%; height: 80%; 
            background: radial-gradient(ellipse at center top, rgba(60, 20, 20, 0.5) 0%, #000000 70%),
                        repeating-linear-gradient(90deg, rgba(255,255,255,0.02) 0px, rgba(255,255,255,0.02) 1px, transparent 1px, transparent 100px);
            transform: rotateX(70deg); transform-origin: top;
            box-shadow: inset 0 50px 150px #000; z-index: 1;
            mask-image: linear-gradient(to bottom, black 20%, transparent 100%);
        }
        .spotlight-beam { 
            position: absolute; top: -200px; left: 50%; width: 1000px; height: 150vh; 
            background: radial-gradient(ellipse at center, rgba(255, 223, 128, 0.15) 0%, rgba(255, 215, 0, 0.02) 40%, transparent 70%); 
            transform: translateX(-50%); pointer-events: none; mix-blend-mode: screen; z-index: 5; filter: blur(50px); 
            opacity: 0.8; transition: opacity 2s ease;
        }
        #visualizer-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; mix-blend-mode: screen; }

        /* --- REALISTIC CURTAINS --- */
        .curtain-container { position: fixed; inset: 0; z-index: 50; pointer-events: none; }
        
        .curtain { 
            position: absolute; top: 0; height: 100%; width: 51%; 
            background-color: var(--velvet);
            background-image: 
                repeating-linear-gradient(90deg, 
                    var(--velvet-shadow) 0%, 
                    var(--velvet) 10%, 
                    var(--velvet-highlight) 20%, 
                    var(--velvet) 30%, 
                    var(--velvet-shadow) 40%),
                url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            background-size: 200px 100%, 200px 200px;
            box-shadow: inset 0 0 100px #000;
            transition: transform 3.5s cubic-bezier(0.77, 0, 0.175, 1), filter 3.5s ease;
            will-change: transform; z-index: 50;
            border-bottom: 8px solid #330000;
        }

        .curtain::after {
            content: ''; position: absolute; bottom: -20px; left: 0; width: 100%; height: 20px;
            background: repeating-linear-gradient(90deg, 
                var(--gold-dim) 0px, 
                var(--gold) 2px, 
                #5a4a00 4px, 
                transparent 4px, 
                transparent 8px);
            box-shadow: 0 -5px 10px rgba(0,0,0,0.8);
        }

        .curtain.left { 
            left: 0; transform-origin: left center; 
            border-right: 2px solid rgba(0,0,0,0.8); 
        }
        .curtain.right { 
            right: 0; transform-origin: right center; 
            border-left: 2px solid rgba(0,0,0,0.8); 
        }
        
        body.curtain-open .curtain.left { transform: translateX(-95%) scaleX(0.2); filter: brightness(0.6); }
        body.curtain-open .curtain.right { transform: translateX(95%) scaleX(0.2); filter: brightness(0.6); }
        
        .spotlight-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 10%, rgba(0,0,0,0.95) 80%);
            opacity: 1; transition: opacity 2.5s ease-in-out; z-index: 51; pointer-events: none;
        }
        body.curtain-open .spotlight-overlay { opacity: 0; }

        /* --- UI LAYER --- */
        .ui-layer { 
            position: relative; z-index: 40; 
            height: 100vh; 
            display: flex; flex-direction: column; 
            overflow-y: auto; 
            padding-top: 50px; 
            padding-bottom: 50px;
        }

        .mixer-grid {
            display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px;
            max-width: 1600px; width: 98%; 
            height: auto; 
            margin: auto;
            transition: all 1.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            opacity: 0; transform: translateY(50px) scale(0.95);
        }
        body.curtain-open .mixer-grid { opacity: 1; transform: translateY(0) scale(1); transition-delay: 0.8s; }

        @media (max-width: 1200px) { .mixer-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .mixer-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 480px) { .mixer-grid { grid-template-columns: 1fr; } }

        /* --- CARDS & ANIMATIONS --- */
        .mixer-col {
            background: rgba(20, 20, 20, 0.85); 
            border: 2px solid #333; 
            border-radius: 20px;
            display: flex; flex-direction: column; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative; cursor: pointer; user-select: none;
            opacity: 0; transform: translateY(100px) scale(0.8);
        }

        .mixer-col::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.1), transparent);
            transform: skewX(-25deg); transition: none; pointer-events: none; z-index: 10;
        }

        .mixer-col:hover { 
            transform: translateY(-15px) scale(1.02); 
            border-color: var(--active-color);
            box-shadow: 0 20px 40px rgba(0,0,0,0.8), 0 0 15px var(--glow-color);
        }
        .mixer-col:hover::before { animation: shineSweep 0.75s; }
        .mixer-col:hover .group-icon-large { transform: scale(1.15) rotate(5deg); text-shadow: 0 0 15px var(--active-color); }

        .mixer-col.active { 
            transform: translateY(-12px) scale(1.03); 
            animation: neonPulse 2s infinite ease-in-out;
            background: linear-gradient(180deg, rgba(20,20,20,0.9), rgba(0,0,0,1));
        }
        
        body.curtain-open .mixer-col { animation: popIn 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        body.curtain-open .mixer-col:nth-child(1) { animation-delay: 1.0s; }
        body.curtain-open .mixer-col:nth-child(2) { animation-delay: 1.15s; }
        body.curtain-open .mixer-col:nth-child(3) { animation-delay: 1.3s; }
        body.curtain-open .mixer-col:nth-child(4) { animation-delay: 1.45s; }
        body.curtain-open .mixer-col:nth-child(5) { animation-delay: 1.6s; }
        body.curtain-open .mixer-col:nth-child(6) { animation-delay: 1.75s; }

        .mixer-col:active { animation: clickBounce 0.2s ease; }

        .card-content { padding: 15px; display: flex; flex-direction: column; height: 100%; text-align: center; z-index: 5; }
        .group-icon-large { font-size: 2.5rem; margin-bottom: 10px; display: block; transition: all 0.3s; }
        .group-title { font-weight: 800; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .group-desc { font-size: 0.75rem; line-height: 1.4; color: #aaa; margin-bottom: 15px; flex-grow: 1; font-style: italic; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .group-association { font-size: 0.65rem; color: #888; margin-top: auto; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        .inst-icons { display: flex; justify-content: center; gap: 8px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 10px; flex-wrap: wrap; transition: 0.3s; }
        .mixer-col.active .inst-icons { background: rgba(255,255,255,0.05); }
        .inst-icon { font-size: 1rem; color: #444; transition: all 0.3s; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 50%; }
        .mixer-col.active .inst-icon { color: #fff; background: rgba(255,255,255,0.2); box-shadow: 0 0 10px currentColor; transform: scale(1.1); }
        
        .group-R { --active-color: var(--color-R); --glow-color: rgba(239, 68, 68, 0.6); } .group-R.active { background: linear-gradient(180deg, rgba(239,68,68,0.15), rgba(20,20,20,0.9)); } .group-R .group-title, .group-R.active .group-icon-large, .group-R.active .inst-icon { color: var(--color-R); }
        .group-I { --active-color: var(--color-I); --glow-color: rgba(59, 130, 246, 0.6); } .group-I.active { background: linear-gradient(180deg, rgba(59,130,246,0.15), rgba(20,20,20,0.9)); } .group-I .group-title, .group-I.active .group-icon-large, .group-I.active .inst-icon { color: var(--color-I); }
        .group-A { --active-color: var(--color-A); --glow-color: rgba(236, 72, 153, 0.6); } .group-A.active { background: linear-gradient(180deg, rgba(236,72,153,0.15), rgba(20,20,20,0.9)); } .group-A .group-title, .group-A.active .group-icon-large, .group-A.active .inst-icon { color: var(--color-A); }
        .group-S { --active-color: var(--color-S); --glow-color: rgba(16, 185, 129, 0.6); } .group-S.active { background: linear-gradient(180deg, rgba(16,185,129,0.15), rgba(20,20,20,0.9)); } .group-S .group-title, .group-S.active .group-icon-large, .group-S.active .inst-icon { color: var(--color-S); }
        .group-E { --active-color: var(--color-E); --glow-color: rgba(139, 92, 246, 0.6); } .group-E.active { background: linear-gradient(180deg, rgba(139,92,246,0.15), rgba(20,20,20,0.9)); } .group-E .group-title, .group-E.active .group-icon-large, .group-E.active .inst-icon { color: var(--color-E); }
        .group-C { --active-color: var(--color-C); --glow-color: rgba(245, 158, 11, 0.6); } .group-C.active { background: linear-gradient(180deg, rgba(245,158,11,0.15), rgba(20,20,20,0.9)); } .group-C .group-title, .group-C.active .group-icon-large, .group-C.active .inst-icon { color: var(--color-C); }

        .landing-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 60; text-align: center; width: 100%; transition: all 1.2s ease-in-out; }
        body.curtain-open .landing-wrapper { opacity: 0; pointer-events: none; transform: translate(-50%, -60%) scale(1.1); filter: blur(10px); }
        .main-title { font-family: 'Pinyon Script', cursive; font-size: 7rem; color: var(--gold); text-shadow: 0 0 40px rgba(255, 215, 0, 0.4); margin: 0; }
        .name-input { background: transparent; border: none; border-bottom: 2px solid rgba(255,215,0,0.3); color: #fff; font-family: 'Pinyon Script', cursive; font-size: 2rem; text-align: center; padding: 10px; margin-top: 3rem; width: 350px; outline: none; transition: all 0.3s; }
        .name-input:focus { border-color: var(--gold); text-shadow: 0 0 10px rgba(255,215,0,0.3); }
        .enter-btn { margin-top: 2rem; padding: 12px 40px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,215,0,0.4); color: var(--gold); font-size: 0.8rem; letter-spacing: 3px; text-transform: uppercase; cursor: pointer; transition: all 0.4s; }
        .enter-btn:hover { background: rgba(255,215,0,0.1); border-color: var(--gold); box-shadow: 0 0 20px rgba(255,215,0,0.3); }

        .header-ui { position: fixed; top: 0; left: 0; width: 100%; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; z-index: 45; opacity: 0; transition: opacity 1s 2s; pointer-events: none; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        body.curtain-open .header-ui { opacity: 1; pointer-events: auto; }
        .logo-small { font-family: 'Pinyon Script', cursive; color: var(--gold); font-size: 1.8rem; }
        .control-panel { display: flex; gap: 15px; }
        .ctrl-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; transition: 0.3s; background: rgba(0,0,0,0.5); }
        .ctrl-btn:hover { background: var(--gold); color: #000; border-color: var(--gold); transform: scale(1.1); box-shadow: 0 0 15px rgba(255,215,0,0.3); }
        .play-btn { width: auto; padding: 0 30px; border-radius: 4px; border-color: var(--gold); color: var(--gold); font-weight: 600; letter-spacing: 2px; font-size: 0.8rem; }
        .play-btn:hover { color: #000; background: var(--gold); box-shadow: 0 0 25px rgba(255,215,0,0.6); }

        #result-overlay {
            position: fixed; inset: 0; z-index: 55; 
            display: flex; flex-direction: column; justify-content: flex-start; 
            align-items: center;
            background: rgba(0,0,0,0.95); backdrop-filter: blur(20px); 
            opacity: 0; pointer-events: none; transition: opacity 1.5s ease; 
            overflow-y: auto; 
            padding-top: 50px;
        }
        body.show-result #result-overlay { opacity: 1; pointer-events: auto; }
        
        .vinyl-container { 
            position: relative; 
            flex: 0 0 180px; 
            width: 180px; height: 180px; 
            margin-bottom: 2rem; 
            animation: spin 4s linear infinite; 
            border-radius: 50%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
        }
        body:not(.playing) .vinyl-container { animation-play-state: paused; }
        
        .vinyl-disk { 
            width: 100%; height: 100%; border-radius: 50%; 
            position: relative;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #000;
            background: 
                linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.0) 50%, rgba(255,255,255,0.1) 55%, transparent 60%),
                repeating-radial-gradient(#111 0, #111 2px, #1c1c1c 3px, #111 4px);
            aspect-ratio: 1/1; 
        }
        .vinyl-disk::before {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            background: conic-gradient(from 0deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.1) 75%, rgba(255,255,255,0.02) 100%);
            mix-blend-mode: overlay; pointer-events: none;
        }

        .vinyl-label { 
            width: 38%; height: 38%; border-radius: 50%; 
            background: radial-gradient(circle at center, #ffd700, #d4af37); 
            color: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; font-size: 0.6rem; padding: 2px;
            box-shadow: 0 0 0 4px #111, inset 0 0 10px rgba(0,0,0,0.5); 
            z-index: 10;
        }
        .vinyl-label::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 6px; height: 6px; background: #000; border-radius: 50%;
            box-shadow: 0 0 1px rgba(255,255,255,0.5);
        }

        .label-text { font-family: 'Pinyon Script', cursive; font-size: 0.9rem; line-height: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 90%; }
        
        .result-content { text-align: center; max-width: 1000px; width: 90%; padding: 0 20px 80px 20px; display: flex; flex-direction: column; align-items: center; }
        .result-title { font-size: 2.5rem; color: var(--gold); font-family: 'Pinyon Script', cursive; margin-bottom: 0.5rem; }
        .analysis-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 2rem; max-width: 800px; }
        .conclusion-box { 
            background: linear-gradient(180deg, rgba(255, 215, 0, 0.05) 0%, rgba(0,0,0,0.2) 100%);
            border-top: 2px solid var(--gold);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px;
            padding: 25px; 
            margin-bottom: 2rem; 
            max-width: 800px; 
            text-align: left;
            position: relative;
        }
        .conclusion-title {
            color: var(--gold);
            font-family: 'Montserrat', sans-serif;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255,215,0,0.2);
            padding-bottom: 10px;
        }
        .analysis-text { font-size: 1rem; line-height: 1.6; color: #ddd; font-style: italic; }
        .conclusion-text { font-size: 0.95rem; line-height: 1.7; color: #e5e5e5; }
        .conclusion-label { color: #aaa; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; display: block; margin-top: 15px; margin-bottom: 5px; border-left: 3px solid var(--gold); padding-left: 10px; }
        .highlight-trait { color: var(--gold); font-weight: 600; }
        .career-section-title { font-size: 1.2rem; text-transform: uppercase; letter-spacing: 2px; color: rgba(255,255,255,0.6); margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); display: inline-block; padding-bottom: 5px; }
        .career-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; margin-bottom: 2rem; }
        .career-group { background: rgba(0,0,0,0.3); border: 1px solid #333; border-radius: 12px; padding: 15px; text-align: left; transition: transform 0.3s; }
        .career-group:hover { transform: translateY(-5px); border-color: var(--gold-dim); }
        .career-group-header { font-size: 1rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; text-transform: uppercase; }
        .career-list-items { display: flex; flex-wrap: wrap; gap: 8px; }
        .career-tag { font-size: 0.8rem; color: #ccc; background: rgba(255,255,255,0.05); padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); }
        #result-btn-container { opacity: 0; transition: opacity 1s 10s; position: fixed; bottom: 30px; right: 30px; z-index: 56; }
        body.playing #result-btn-container { opacity: 1; }
        .show-result-btn { background: rgba(0,0,0,0.6); border: 1px solid var(--gold); color: var(--gold); padding: 10px 25px; border-radius: 30px; font-size: 0.7rem; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; }
        .show-result-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 20px var(--gold); }
    </style>
</head>
<body>

    <!-- STAGE -->
    <div class="stage-container">
        <div class="stage-floor"></div>
        <div id="spotlight" class="spotlight-beam"></div>
        <canvas id="visualizer-canvas"></canvas>
    </div>

    <!-- CURTAINS -->
    <div class="curtain-container">
        <div class="curtain left"></div>
        <div class="curtain right"></div>
        <div class="spotlight-overlay"></div>
    </div>

    <!-- LANDING -->
    <div class="landing-wrapper">
        <h1 class="main-title">The Future Orchestra</h1>
        <p class="text-xs tracking-[0.5em] text-gray-400 mt-4 uppercase">The Ultimate Conductor Experience</p>
        <div class="flex flex-col items-center">
            <input type="text" id="user-name" class="name-input" placeholder="Tên của bạn..." autocomplete="off">
            <button class="enter-btn" onclick="app.enterStage()">Bước lên bục</button>
        </div>
    </div>

    <!-- RESULT TRIGGER -->
    <div id="result-btn-container">
        <button class="show-result-btn" onclick="app.showResult()">XEM KẾT QUẢ &rarr;</button>
    </div>

    <!-- RESULT OVERLAY (VINYL STYLE) -->
    <div id="result-overlay">
        <div class="vinyl-container">
            <div class="vinyl-disk"><div class="vinyl-label"><span class="text-[8px] uppercase tracking-widest mb-1">Conductor</span><span id="label-name" class="label-text">Name</span></div></div>
        </div>
        <div class="result-content">
            <h2 class="result-title">Bản Giao Hưởng Sự Nghiệp</h2>
            
            <div class="analysis-box"><p id="analysis-text" class="analysis-text">Đang phân tích...</p></div>
            
            <!-- NEW CONCLUSION SECTION -->
            <div id="conclusion-container" class="conclusion-box" style="display:none;">
                <h3 class="conclusion-title">Tổng Kết Chuyên Sâu: Bản Ngã & Âm Nhạc</h3>
                <div id="conclusion-content" class="conclusion-text"></div>
            </div>

            <h3 class="career-section-title">Nghề Nghiệp Gợi Ý</h3>
            <div id="career-grid" class="career-grid"></div>
            <button class="enter-btn" onclick="app.replay()">Phối Khí Lại</button>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="header-ui">
        <div class="logo-small">The Future Orchestra</div>
        <div class="control-panel">
            <button class="ctrl-btn" onclick="app.reset()" title="Reset All"><i class="fas fa-undo"></i></button>
            <button id="main-play-btn" class="ctrl-btn play-btn" onclick="app.togglePlay()"><i class="fas fa-play mr-2"></i> PLAY</button>
        </div>
    </div>

    <div class="ui-layer">
        <div class="mixer-grid">
            <!-- R -->
            <div id="card-R" class="mixer-col group-R" onclick="app.toggleGroup('R')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-hammer"></i></span>
                    <h2 class="group-title">Kỹ Thuật (R)</h2>
                    <p class="group-desc">Realistic: Thích hành động cụ thể, máy móc, sự vững chãi.</p>
                    <div class="group-association">Vocals: Giọng Tenor (Hô hào)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-drum"></i></div>
                        <div class="inst-icon"><i class="fas fa-drum-steelpan"></i></div>
                        <div class="inst-icon"><i class="fas fa-guitar"></i></div>
                        <div class="inst-icon"><i class="fas fa-microphone"></i></div>
                    </div>
                </div>
            </div>
            <!-- I -->
            <div id="card-I" class="mixer-col group-I" onclick="app.toggleGroup('I')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-search"></i></span>
                    <h2 class="group-title">Nghiên Cứu (I)</h2>
                    <p class="group-desc">Investigative: Thích quan sát, phân tích, tư duy logic.</p>
                    <div class="group-association">Vocals: Giọng Nữ Cao (Soprano)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-keyboard"></i></div>
                        <div class="inst-icon"><i class="fas fa-music"></i></div>
                        <div class="inst-icon"><i class="fas fa-bell"></i></div>
                        <div class="inst-icon"><i class="fas fa-microphone-alt"></i></div>
                    </div>
                </div>
            </div>
            <!-- A -->
            <div id="card-A" class="mixer-col group-A" onclick="app.toggleGroup('A')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-palette"></i></span>
                    <h2 class="group-title">Nghệ Thuật (A)</h2>
                    <p class="group-desc">Artistic: Trực giác, sáng tạo, giàu trí tưởng tượng.</p>
                    <div class="group-association">Vocals: Giọng Gió (Whisper)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-wind"></i></div>
                        <div class="inst-icon"><i class="fas fa-guitar"></i></div>
                        <div class="inst-icon"><i class="fas fa-cloud"></i></div>
                        <div class="inst-icon"><i class="fas fa-microphone-lines"></i></div>
                    </div>
                </div>
            </div>
            <!-- S -->
            <div id="card-S" class="mixer-col group-S" onclick="app.toggleGroup('S')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-handshake"></i></span>
                    <h2 class="group-title">Xã Hội (S)</h2>
                    <p class="group-desc">Social: Thích giúp đỡ, sẻ chia, kết nối cộng đồng.</p>
                    <div class="group-association">Vocals: Dàn Đồng Ca (Choir)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-guitar"></i></div>
                        <div class="inst-icon"><i class="fas fa-box-open"></i></div>
                        <div class="inst-icon"><i class="fas fa-bottle-water"></i></div>
                        <div class="inst-icon"><i class="fas fa-users"></i></div>
                    </div>
                </div>
            </div>
            <!-- E -->
            <div id="card-E" class="mixer-col group-E" onclick="app.toggleGroup('E')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-briefcase"></i></span>
                    <h2 class="group-title">Quản Lý (E)</h2>
                    <p class="group-desc">Enterprising: Thích tác động, lãnh đạo, quản lý, quyền lực.</p>
                    <div class="group-association">Vocals: Giọng Hùng Biện (Baritone)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-bolt"></i></div>
                        <div class="inst-icon"><i class="fas fa-bullhorn"></i></div>
                        <div class="inst-icon"><i class="fas fa-database"></i></div>
                        <div class="inst-icon"><i class="fas fa-microphone-lines-slash"></i></div>
                    </div>
                </div>
            </div>
            <!-- C -->
            <div id="card-C" class="mixer-col group-C" onclick="app.toggleGroup('C')">
                <div class="card-content">
                    <span class="group-icon-large"><i class="fas fa-folder-open"></i></span>
                    <h2 class="group-title">Nghiệp Vụ (C)</h2>
                    <p class="group-desc">Conventional: Thích trật tự, con số, chi tiết, ổn định.</p>
                    <div class="group-association">Vocals: Ngân Nga (Hum)</div>
                    <div class="inst-icons">
                        <div class="inst-icon"><i class="fas fa-ellipsis-vertical"></i></div>
                        <div class="inst-icon"><i class="fas fa-wind"></i></div>
                        <div class="inst-icon"><i class="fas fa-square"></i></div>
                        <div class="inst-icon"><i class="fas fa-user-clock"></i></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DỮ LIỆU TÍNH CÁCH
        const personalityData = {
            'R': { name: 'Kỹ thuật', color: '#ef4444', icon: '<i class="fas fa-hammer"></i>', metaphor: 'vững chãi và thực tế như nhịp trống Bass', desc: 'Bạn là người thực tế, thích hành động cụ thể hơn là lời nói suông. Bạn tìm thấy niềm vui khi tương tác với thế giới vật chất.', careers: ['Thợ làm bánh', 'Đầu bếp', 'Thợ máy máy bay', 'Kỹ sư', 'Thợ sơn', 'Kỹ sư ô tô', 'Thợ điện', 'Thợ làm kính', 'Y tá điều dưỡng'] },
            'I': { name: 'Nghiên cứu', color: '#3b82f6', icon: '<i class="fas fa-search"></i>', metaphor: 'sắc sảo và chi tiết như tiếng đàn Violin', desc: 'Bạn có tư duy logic sắc bén, luôn tò mò về bản chất của mọi vấn đề. Thế giới với bạn là một câu đố cần lời giải.', careers: ['Nhà khảo cổ học', 'Nhà hóa học', 'Nhà vật lí học', 'Nhà địa lý học', 'Nhà sinh vật học', 'Nha sĩ', 'Dược sĩ', 'Kỹ sư phần mềm'] },
            'A': { name: 'Nghệ thuật', color: '#ec4899', icon: '<i class="fas fa-palette"></i>', metaphor: 'bay bổng và tự do như tiếng kèn Saxophone', desc: 'Bạn sở hữu tâm hồn nhạy cảm và trực giác mạnh mẽ. Sự sáng tạo là ngôn ngữ chính để bạn giao tiếp với thế giới.', careers: ['Diễn viên', 'Giáo viên dạy kịch', 'Phóng viên', 'Thợ chụp hình', 'Giám đốc quảng cáo', 'Thiết kế đồ họa', 'Kiến trúc sư'] },
            'S': { name: 'Xã hội', color: '#10b981', icon: '<i class="fas fa-handshake"></i>', metaphor: 'ấm áp và kết nối như tiếng đàn Ukulele', desc: 'Bạn là người của cộng đồng, luôn sẵn lòng sẻ chia và giúp đỡ. Năng lượng của bạn đến từ sự tương tác giữa người với người.', careers: ['Giáo sĩ', 'Bộ trưởng', 'Thị trưởng', 'Giáo sư', 'Giáo viên THPT', 'Nhà hoạt động xã hội', 'Thủ thư', 'Nhà trị liệu', 'Tư vấn học đường'] },
            'E': { name: 'Quản lý', color: '#8b5cf6', icon: '<i class="fas fa-briefcase"></i>', metaphor: 'quyền lực và dẫn dắt như tiếng kèn Trumpet', desc: 'Bạn sinh ra để dẫn đầu. Khả năng thuyết phục và tầm nhìn chiến lược giúp bạn dễ dàng tập hợp mọi người về một mục tiêu chung.', careers: ['Đại diện bán ô tô', 'Giám đốc tín dụng', 'NV bất động sản', 'NV bán bảo hiểm', 'Chủ doanh nghiệp', 'Quản lí khách sạn', 'Người vận động hành lang', 'Người mua bán chứng khoán'] },
            'C': { name: 'Nghiệp vụ', color: '#f59e0b', icon: '<i class="fas fa-folder-open"></i>', metaphor: 'ổn định và tỉ mỉ như nhịp gõ Woodblock', desc: 'Bạn là người của sự trật tự và quy chuẩn. Sự cẩn trọng và khả năng tổ chức của bạn là nền tảng vững chắc cho mọi thành công.', careers: ['Kế toán', 'Kiểm toán viên', 'Thanh tra xây dựng', 'Người vận hành máy tính', 'Thủ thư', 'Thu ngân', 'Thư ký pháp lí', 'Giáo viên'] }
        };

        // --- OPERA AUDIO ENGINE ---
        const audioEngine = {
            ctx: null, master: null, reverb: null, busCompressor: null,
            tempo: 110, step: 0, nextNoteTime: 0, isPlaying: false,
            activeGroups: { R: false, I: false, A: false, S: false, E: false, C: false },
            
            createReverb: function(duration, decay) {
                const len = this.ctx.sampleRate * duration;
                const buffer = this.ctx.createBuffer(2, len, this.ctx.sampleRate);
                for (let c = 0; c < 2; c++) {
                    const ch = buffer.getChannelData(c);
                    for (let i = 0; i < len; i++) {
                        ch[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
                    }
                }
                return buffer;
            },

            // THE SINGER'S FORMANT (3kHz Boost) - Secret sauce for Opera
            applySingersFormant: function(source) {
                const ring = this.ctx.createBiquadFilter();
                ring.type = 'peaking';
                ring.frequency.value = 3000; // The "Singing Formant" range
                ring.Q.value = 3;
                ring.gain.value = 8; // Boost the "ring"
                
                source.connect(ring);
                return ring;
            },

            createVocalTract: function(source, vowelType) {
                // Opera vowels are more "open" and resonant
                const formants = {
                    'a': [ {f: 800, db: 0}, {f: 1200, db: -6}, {f: 2800, db: -12} ], // Open Opera 'Aah'
                    'o': [ {f: 500, db: 0}, {f: 900, db: -8}, {f: 2500, db: -15} ],  // Deep Opera 'Ooh'
                    'e': [ {f: 400, db: 0}, {f: 2000, db: -6}, {f: 2800, db: -10} ], // Bright 'Eh'
                    'u': [ {f: 350, db: 0}, {f: 800, db: -10}, {f: 2400, db: -20} ],  // Resonant 'Uh'
                };
                const specs = formants[vowelType] || formants['a'];
                const output = this.ctx.createGain();
                
                specs.forEach(spec => {
                    const filter = this.ctx.createBiquadFilter();
                    filter.type = 'bandpass'; filter.frequency.value = spec.f; filter.Q.value = 4;
                    const gain = this.ctx.createGain(); gain.gain.value = Math.pow(10, spec.db / 20) * 4; // Makeup gain
                    source.connect(filter); filter.connect(gain); gain.connect(output);
                });
                
                // Add the singer's formant at the end
                return this.applySingersFormant(output);
            },

            init: function() {
                if (this.ctx) return;
                const AC = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AC();
                this.master = this.ctx.createGain(); this.master.gain.value = 0.8;
                
                // Limiter
                this.busCompressor = this.ctx.createDynamicsCompressor();
                this.busCompressor.threshold.value = -12; this.busCompressor.ratio.value = 6;
                
                // Large Hall Reverb for Opera House feel
                this.reverb = this.ctx.createConvolver();
                this.reverb.buffer = this.createReverb(3.5, 2.5); 
                const reverbGain = this.ctx.createGain(); reverbGain.gain.value = 0.45;
                
                this.master.connect(this.busCompressor);
                this.busCompressor.connect(this.ctx.destination);
                this.busCompressor.connect(this.reverb);
                this.reverb.connect(this.ctx.destination);
                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 256;
                this.busCompressor.connect(this.analyser);
                visualizer.init(this.analyser);
            },

            // --- OPERA INSTRUMENTS & VOCALS ---

            // R: Realistic - Mechanical + TENOR CHANT (Robust)
            playKickR: function(t) { const osc = this.ctx.createOscillator(); osc.frequency.setValueAtTime(150, t); osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5); const g = this.ctx.createGain(); g.gain.setValueAtTime(1, t); g.gain.exponentialRampToValueAtTime(0.01, t + 0.3); osc.connect(g); g.connect(this.master); osc.start(t); osc.stop(t + 0.5); },
            playSnareR: function(t) { const noise = this.ctx.createBufferSource(); const bSize = this.ctx.sampleRate; const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate); const d = b.getChannelData(0); for(let i=0; i<bSize; i++) d[i] = Math.random()*2-1; noise.buffer = b; const f = this.ctx.createBiquadFilter(); f.type='highpass'; f.frequency.value = 1500; const g = this.ctx.createGain(); g.gain.setValueAtTime(0.7, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.15); noise.connect(f); f.connect(g); g.connect(this.master); noise.start(t); },
            playBassR: function(t, freq) { const osc = this.ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = freq; const g = this.ctx.createGain(); g.gain.setValueAtTime(0.6, t); g.gain.linearRampToValueAtTime(0.5, t+0.1); g.gain.exponentialRampToValueAtTime(0.001, t+0.4); osc.connect(g); g.connect(this.master); osc.start(t); osc.stop(t+0.5); },
            playChantR: function(t) { 
                // Masculine 'Uh' Chant with Chest Resonance
                const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; 
                osc.frequency.setValueAtTime(110, t); 
                osc.frequency.exponentialRampToValueAtTime(90, t+0.2); // Vocal dip
                const noise = this.ctx.createBufferSource(); // Air
                const bSize = this.ctx.sampleRate * 0.2; const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate); const d = b.getChannelData(0); for(let i=0; i<bSize; i++) d[i] = Math.random()*2-1; noise.buffer = b; 
                
                const mix = this.ctx.createGain(); mix.gain.value = 0.6; 
                osc.connect(mix); noise.connect(mix); 
                
                const throat = this.createVocalTract(mix, 'u'); // 'Uh'
                
                const g = this.ctx.createGain(); 
                g.gain.setValueAtTime(0.5, t); 
                g.gain.linearRampToValueAtTime(0.4, t+0.1);
                g.gain.exponentialRampToValueAtTime(0.001, t+0.3); 
                
                throat.connect(g); g.connect(this.master); 
                osc.start(t); noise.start(t); osc.stop(t+0.35); noise.stop(t+0.35); 
            },

            // I: Investigative - Analytical + SOPRANO (Pure, High, Vibrato)
            playArpI: function(t, freq) { const carrier = this.ctx.createOscillator(); carrier.frequency.value = freq; const mod = this.ctx.createOscillator(); mod.frequency.value = freq * 2.0; const modGain = this.ctx.createGain(); modGain.gain.value = 300; mod.connect(modGain); modGain.connect(carrier.frequency); const g = this.ctx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.3, t + 0.01); g.gain.exponentialRampToValueAtTime(0.001, t + 0.4); carrier.connect(g); g.connect(this.master); carrier.start(t); mod.start(t); carrier.stop(t+0.5); mod.stop(t+0.5); },
            playSopranoI: function(t, freq) { 
                // Pure Soprano "Ooh"
                const osc = this.ctx.createOscillator(); osc.type = 'triangle'; // Smoother tone
                osc.frequency.value = freq * 4; 
                
                // Deep, slow opera vibrato (5Hz)
                const vib = this.ctx.createOscillator(); vib.frequency.value = 5.0; 
                const vibGain = this.ctx.createGain(); vibGain.gain.value = 15; // Wide pitch swing
                vib.connect(vibGain); vibGain.connect(osc.frequency); 
                vib.start(t); vib.stop(t+4); 
                
                const throat = this.createVocalTract(osc, 'o'); 
                
                const g = this.ctx.createGain(); 
                g.gain.setValueAtTime(0, t); 
                g.gain.linearRampToValueAtTime(0.3, t+0.5); // Slow swelling attack
                g.gain.linearRampToValueAtTime(0.2, t+2.0); 
                g.gain.linearRampToValueAtTime(0, t+3.8); 
                
                throat.connect(g); g.connect(this.reverb); 
                osc.start(t); osc.stop(t+4); 
            },

            // A: Artistic - Expressive + WHISPER (Airy)
            playPadA: function(t, chord) { const freq = chord; [0.995, 1.005].forEach(detune => { const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = freq * detune; const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 600; filter.frequency.setValueAtTime(600, t); filter.frequency.linearRampToValueAtTime(1200, t + 1.5); filter.frequency.linearRampToValueAtTime(400, t + 3.0); const g = this.ctx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.15, t+1.0); g.gain.linearRampToValueAtTime(0, t+3.5); osc.connect(filter); filter.connect(g); g.connect(this.reverb); osc.start(t); osc.stop(t+4.0); }); },
            playLeadA: function(t, freq) { const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; osc.frequency.value = freq; const vib = this.ctx.createOscillator(); vib.frequency.value = 5; const vibG = this.ctx.createGain(); vibG.gain.value = 5; vib.connect(vibG); vibG.connect(osc.frequency); const filter = this.ctx.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value = 2000; const g = this.ctx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t+0.2); g.gain.linearRampToValueAtTime(0, t+1.0); osc.connect(filter); filter.connect(g); g.connect(this.reverb); osc.start(t); vib.start(t); osc.stop(t+1.2); vib.stop(t+1.2); },
            playWhisperA: function(t) { 
                // Ethereal Voice (Air dominant)
                const bSize = this.ctx.sampleRate * 3; const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate); const d = b.getChannelData(0); var lastOut = 0; 
                for(let i=0; i<bSize; i++) { const white = Math.random() * 2 - 1; d[i] = (lastOut + (0.02 * white)) / 1.02; lastOut = d[i]; d[i] *= 3.5; } 
                const n = this.ctx.createBufferSource(); n.buffer = b; 
                
                // Formant sweep 'U' -> 'A'
                const f = this.ctx.createBiquadFilter(); f.type = 'bandpass'; f.Q.value = 2; 
                f.frequency.setValueAtTime(400, t); f.frequency.linearRampToValueAtTime(1200, t+2.0); 
                
                const g = this.ctx.createGain(); 
                g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.15, t+1.5); g.gain.linearRampToValueAtTime(0, t+3.0); 
                
                n.connect(f); f.connect(g); g.connect(this.reverb); n.start(t); 
            },

            // S: Social - Warm + CHOIR (Grand Opera Chorus)
            playChoirS: function(t, chord) { 
                const notes = [chord.root, chord.third, chord.fifth]; 
                notes.forEach((freq, idx) => { 
                    // 3 Voices per note for thickness
                    [0.995, 1.0, 1.005].forEach(detune => { 
                        const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; // Rich harmonics
                        osc.frequency.value = freq * detune; 
                        
                        // Randomized Vibrato per voice
                        const vib = this.ctx.createOscillator(); vib.frequency.value = 4.5 + Math.random(); 
                        const vibG = this.ctx.createGain(); vibG.gain.value = 3; 
                        vib.connect(vibG); vibG.connect(osc.frequency); vib.start(t); vib.stop(t+4.0); 
                        
                        // 'Aah' Formant
                        const throat = this.createVocalTract(osc, 'a'); 
                        
                        const env = this.ctx.createGain(); 
                        env.gain.setValueAtTime(0, t); 
                        env.gain.linearRampToValueAtTime(0.05, t + 0.8); // Gentle entry
                        env.gain.linearRampToValueAtTime(0.04, t + 3.0); 
                        env.gain.exponentialRampToValueAtTime(0.001, t + 4.0); 
                        
                        throat.connect(env); env.connect(this.master); env.connect(this.reverb); 
                        osc.start(t); osc.stop(t + 4.0); 
                    }); 
                }); 
            },
            playUkeS: function(t, freq) { const osc = this.ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = freq; const g = this.ctx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.25, t+0.02); g.gain.exponentialRampToValueAtTime(0.001, t+0.3); const f = this.ctx.createBiquadFilter(); f.type='peaking'; f.frequency.value = 800; f.gain.value = 5; osc.connect(f); f.connect(g); g.connect(this.master); osc.start(t); osc.stop(t+0.35); },
            playShakerS: function(t) { const bSize = this.ctx.sampleRate * 0.1; const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate); const d = b.getChannelData(0); for(let i=0; i<bSize; i++) d[i] = Math.random()*2-1; const n = this.ctx.createBufferSource(); n.buffer = b; const f = this.ctx.createBiquadFilter(); f.type='bandpass'; f.frequency.value = 6000; const g = this.ctx.createGain(); g.gain.setValueAtTime(0.05, t); g.gain.linearRampToValueAtTime(0.1, t+0.01); g.gain.linearRampToValueAtTime(0, t+0.05); n.connect(f); f.connect(g); g.connect(this.master); n.start(t); },

            // E: Enterprising - Bold + BARITONE SHOUT (Authoritative)
            playBrassSectionE: function(t, chord) { const freqs = [chord.root, chord.fifth, chord.root * 2]; freqs.forEach((f, i) => { const osc1 = this.ctx.createOscillator(); osc1.type = 'sawtooth'; osc1.frequency.value = f; const osc2 = this.ctx.createOscillator(); osc2.type = 'sawtooth'; osc2.frequency.value = f * 1.008; const filter = this.ctx.createBiquadFilter(); filter.type = 'lowpass'; filter.Q.value = 2; filter.frequency.setValueAtTime(f, t); filter.frequency.linearRampToValueAtTime(f * 3.5, t + 0.05); filter.frequency.exponentialRampToValueAtTime(f, t + 0.3); const amp = this.ctx.createGain(); amp.gain.setValueAtTime(0, t); amp.gain.linearRampToValueAtTime(0.25 / (i+1), t + 0.02); amp.gain.exponentialRampToValueAtTime(0.001, t + 0.4); osc1.connect(filter); osc2.connect(filter); filter.connect(amp); amp.connect(this.master); amp.connect(this.reverb); osc1.start(t); osc2.start(t); osc1.stop(t+0.5); osc2.stop(t+0.5); }); },
            playPowerChordE: function(t, rootFreq) { const oscRoot = this.ctx.createOscillator(); oscRoot.type = 'sawtooth'; oscRoot.frequency.value = rootFreq; const oscFifth = this.ctx.createOscillator(); oscFifth.type = 'sawtooth'; oscFifth.frequency.value = rootFreq * 1.5; const dist = this.ctx.createWaveShaper(); const k = 100; const n_samples = 44100; const curve = new Float32Array(n_samples); for (let i=0; i<n_samples; ++i ) { const x = i * 2 / n_samples - 1; curve[i] = ( 3 + k ) * x * 20 * ( Math.PI / 180 ) / ( Math.PI + k * Math.abs(x) ); } dist.curve = curve; dist.oversample = '4x'; const cabSim = this.ctx.createBiquadFilter(); cabSim.type = 'lowpass'; cabSim.frequency.value = 2500; const amp = this.ctx.createGain(); amp.gain.setValueAtTime(0, t); amp.gain.linearRampToValueAtTime(0.3, t + 0.05); amp.gain.exponentialRampToValueAtTime(0.001, t + 0.8); oscRoot.connect(dist); oscFifth.connect(dist); dist.connect(cabSim); cabSim.connect(amp); amp.connect(this.master); oscRoot.start(t); oscFifth.start(t); oscRoot.stop(t+1.0); oscFifth.stop(t+1.0); },
            playStompE: function(t) { const osc = this.ctx.createOscillator(); osc.frequency.setValueAtTime(100, t); osc.frequency.exponentialRampToValueAtTime(20, t + 0.3); const noise = this.ctx.createBufferSource(); const bSize = this.ctx.sampleRate * 0.2; const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate); const d = b.getChannelData(0); for(let i=0; i<bSize; i++) d[i] = Math.random()*2-1; noise.buffer = b; const noiseFilter = this.ctx.createBiquadFilter(); noiseFilter.type = 'lowpass'; noiseFilter.frequency.value = 400; const amp = this.ctx.createGain(); amp.gain.setValueAtTime(1.0, t); amp.gain.exponentialRampToValueAtTime(0.01, t + 0.4); osc.connect(amp); noise.connect(noiseFilter); noiseFilter.connect(amp); amp.connect(this.master); amp.connect(this.reverb); osc.start(t); osc.stop(t+0.5); noise.start(t); },
            playShoutE: function(t) { 
                // "HEY!" - Baritone range, grit
                const osc = this.ctx.createOscillator(); osc.type = 'sawtooth'; 
                osc.frequency.value = 220; osc.frequency.linearRampToValueAtTime(200, t+0.2); 
                
                // Bright 'Eh' Formant + Distortion
                const throat = this.createVocalTract(osc, 'e'); 
                const dist = this.ctx.createWaveShaper(); dist.curve = this.makeDistortionCurve(15); 
                
                const g = this.ctx.createGain(); 
                g.gain.setValueAtTime(0.4, t); 
                g.gain.exponentialRampToValueAtTime(0.01, t+0.3); 
                
                throat.connect(dist); dist.connect(g); g.connect(this.master); 
                osc.start(t); osc.stop(t+0.35); 
            },
            makeDistortionCurve: function(amount) { const n = 44100; const curve = new Float32Array(n); const deg = Math.PI / 180; for (let i = 0; i < n; ++i) { const x = i * 2 / n - 1; curve[i] = (3 + amount) * x * 20 * deg / (Math.PI + amount * Math.abs(x)); } return curve; },

            // C: Conventional - Clockwork + HUM (Steady Mmm)
            playWoodblockC: function(t) { const osc = this.ctx.createOscillator(); osc.frequency.value = 800; const g = this.ctx.createGain(); g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.05); osc.connect(g); g.connect(this.master); osc.start(t); osc.stop(t+0.06); },
            playClarinetC: function(t, freq) { const osc = this.ctx.createOscillator(); osc.type = 'square'; osc.frequency.value = freq; const f = this.ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value = 1200; const g = this.ctx.createGain(); g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t+0.05); g.gain.linearRampToValueAtTime(0.2, t+0.3); g.gain.exponentialRampToValueAtTime(0.001, t+0.4); osc.connect(f); f.connect(g); g.connect(this.master); osc.start(t); osc.stop(t+0.5); },
            playHumC: function(t, freq) { 
                // "Mmm..." - Very closed formant
                const osc = this.ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.value = freq; 
                
                const throat = this.createVocalTract(osc, 'u'); // Start with Uh
                // Heavy lowpass to simulate closed mouth
                const f = this.ctx.createBiquadFilter(); f.type = 'lowpass'; f.frequency.value = 300; 
                
                const g = this.ctx.createGain(); 
                g.gain.setValueAtTime(0, t); 
                g.gain.linearRampToValueAtTime(0.3, t+0.05); 
                g.gain.linearRampToValueAtTime(0.3, t+0.2); 
                g.gain.linearRampToValueAtTime(0, t+0.25); 
                
                throat.connect(f); f.connect(g); g.connect(this.master); 
                osc.start(t); osc.stop(t+0.3); 
            },

            schedule: function(step, t) {
                const s = step % 32;
                const chords = { 0: { root: 130.81, third: 155.56, fifth: 196.00 }, 1: { root: 130.81, third: 155.56, fifth: 196.00 }, 2: { root: 174.61, third: 207.65, fifth: 261.63 }, 3: { root: 196.00, third: 246.94, fifth: 293.66 } };
                const bar = Math.floor(s/8) % 4;
                const harmony = chords[bar];

                if (this.activeGroups.R) {
                    if (s%4 === 0) this.playKickR(t);
                    if (s%8 === 4) this.playSnareR(t);
                    if (s%2 === 0) this.playBassR(t, harmony.root / 2);
                    if (s%8 === 4) this.playChantR(t);
                }
                if (this.activeGroups.I) {
                    const arpNotes = [harmony.root, harmony.third, harmony.fifth, harmony.root*2];
                    if (s%2 === 0) { const note = arpNotes[(s/2)%4]; this.playArpI(t, note * 2); }
                    if (s%16 === 0) this.playSopranoI(t, harmony.root * 4);
                }
                if (this.activeGroups.A) {
                    if (s === 0 || s === 16) this.playPadA(t, harmony.root); 
                    if (Math.random() > 0.6 && s%4!==0) { const humanize = (Math.random() * 0.05); const note = (Math.random() > 0.5) ? harmony.third : harmony.fifth; this.playLeadA(t + humanize, note * 2); }
                    if (s%32 === 24) this.playWhisperA(t);
                }
                if (this.activeGroups.S) {
                    const swing = 0.03; const time = (s%2===1) ? t + swing : t;
                    if (s%4 === 2) this.playUkeS(time, harmony.root * 2);
                    if (s%4 === 3) this.playUkeS(time, harmony.third * 2);
                    if (s%2 === 0) this.playShakerS(time);
                    if (s === 0 || s === 16) this.playChoirS(t, harmony);
                }
                if (this.activeGroups.E) {
                    if (s === 0 || s === 16) { this.playStompE(t); this.playBrassSectionE(t, harmony); }
                    if (s === 6 || s === 22) this.playBrassSectionE(t, harmony);
                    if (s%8 === 0 || s%8 === 3 || s%8 === 6) this.playPowerChordE(t, harmony.root / 2);
                    if (s === 0 || s === 16) this.playShoutE(t); 
                }
                if (this.activeGroups.C) {
                    if (s%4 === 0) this.playWoodblockC(t);
                    if (s%4 === 2) this.playWoodblockC(t + 0.05);
                    if (s%8 === 0) this.playClarinetC(t, harmony.root);
                    if (s%4 === 0) this.playHumC(t, harmony.root);
                }
            },

            clock: function() {
                const lookahead = 0.1;
                while (this.nextNoteTime < this.ctx.currentTime + lookahead) {
                    this.schedule(this.step, this.nextNoteTime);
                    this.nextNoteTime += (60.0 / this.tempo) / 4;
                    this.step++;
                }
                if (this.isPlaying) requestAnimationFrame(this.clock.bind(this));
            },

            toggle: function() {
                if (this.isPlaying) {
                    this.isPlaying = false;
                    document.body.classList.remove('playing');
                    document.getElementById('main-play-btn').innerHTML = '<i class="fas fa-play mr-2"></i> BẮT ĐẦU';
                } else {
                    this.init();
                    if (this.ctx.state === 'suspended') this.ctx.resume();
                    this.isPlaying = true;
                    this.nextNoteTime = this.ctx.currentTime + 0.1;
                    this.step = 0;
                    this.clock();
                    document.body.classList.add('playing');
                    document.getElementById('main-play-btn').innerHTML = '<i class="fas fa-stop mr-2"></i> DỪNG';
                    setTimeout(() => { if(this.isPlaying) document.getElementById('result-btn-container').style.opacity = '1'; }, 5000);
                }
            },
            
            setGroups: function(groupId, isActive) {
                this.activeGroups[groupId] = isActive;
                if (!this.isPlaying && isActive) this.toggle();
            }
        };

        const visualizer = {
            canvas: document.getElementById('visualizer-canvas'),
            ctx: document.getElementById('visualizer-canvas').getContext('2d'),
            analyser: null,
            init: function(analyser) { this.analyser = analyser; this.resize(); window.addEventListener('resize', () => this.resize()); this.animate(); },
            resize: function() { this.canvas.width = window.innerWidth; this.canvas.height = 200; },
            animate: function() {
                requestAnimationFrame(() => this.animate());
                if(!this.analyser) return;
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                this.analyser.getByteFrequencyData(dataArray);
                const w = this.canvas.width; const h = this.canvas.height;
                this.ctx.clearRect(0, 0, w, h);
                const barWidth = (w / bufferLength) * 2.5;
                let x = 0;
                for(let i = 0; i < bufferLength; i++) {
                    const barHeight = dataArray[i] / 1.5;
                    const r = barHeight + (25 * (i/bufferLength)); const g = 250 * (i/bufferLength); const b = 50;
                    this.ctx.fillStyle = `rgb(${r},${g},${b})`;
                    this.ctx.fillRect(x, h - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
        };

        const app = {
            enterStage: function() {
                const name = document.getElementById('user-name').value;
                if(!name) { alert("Xin hãy nhập tên của bạn"); return; }
                if (!audioEngine.ctx) { audioEngine.init(); } else if (audioEngine.ctx.state === 'suspended') { audioEngine.ctx.resume(); }
                document.body.classList.add('curtain-open');
            },
            toggleGroup: function(groupId) {
                if (audioEngine.ctx && audioEngine.ctx.state === 'suspended') audioEngine.ctx.resume();
                const card = document.getElementById(`card-${groupId}`);
                const isActive = !card.classList.contains('active');
                card.classList.toggle('active');
                audioEngine.setGroups(groupId, isActive);
            },
            togglePlay: function() { audioEngine.toggle(); },
            reset: function() {
                ['R','I','A','S','E','C'].forEach(id => {
                    document.getElementById('card-'+id).classList.remove('active');
                    audioEngine.activeGroups[id] = false;
                });
                if(audioEngine.isPlaying) audioEngine.toggle();
                document.getElementById('main-play-btn').innerHTML = '<i class="fas fa-play mr-2"></i> PLAY';
            },
            showResult: function() {
                const name = document.getElementById('user-name').value;
                document.getElementById('label-name').innerText = name || 'Nhạc trưởng';
                let scores = [];
                for (const [key, isActive] of Object.entries(audioEngine.activeGroups)) {
                    if(isActive) scores.push({ id: key, score: 1 });
                }
                
                const analysisTextEl = document.getElementById('analysis-text');
                const careerGridEl = document.getElementById('career-grid');
                const conclusionDiv = document.getElementById('conclusion-container');
                const conclusionContent = document.getElementById('conclusion-content');
                
                careerGridEl.innerHTML = '';
                
                if (scores.length === 0) {
                    analysisTextEl.innerHTML = "Bạn chưa chọn nhạc cụ nào. Hãy quay lại và chỉ huy dàn nhạc để khám phá bản thân!";
                    conclusionDiv.style.display = 'none';
                    return;
                }

                // 1. Individual Analysis
                let analysisHTML = "";
                const traitsList = scores.map(g => `<span class="highlight-trait" style="color:${personalityData[g.id].color}">${personalityData[g.id].name}</span>`).join(', ');
                analysisHTML += `Bản giao hưởng của bạn là sự hòa quyện tuyệt vời giữa năng lượng của ${traitsList}.<br><br>`;
                scores.forEach(g => {
                    const data = personalityData[g.id];
                    analysisHTML += `Với tố chất <b>${data.name}</b>, bạn ${data.metaphor}. ${data.desc}<br><br>`;
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'career-group';
                    groupDiv.style.borderLeft = `4px solid ${data.color}`;
                    let tagsHTML = data.careers.map(c => `<span class="career-tag">${c}</span>`).join('');
                    groupDiv.innerHTML = `<div class="career-group-header" style="color: ${data.color}"><span>${data.icon}</span> Nhóm ${data.name} (${g.id})</div><div class="career-list-items">${tagsHTML}</div>`;
                    careerGridEl.appendChild(groupDiv);
                });
                analysisTextEl.innerHTML = analysisHTML;

                // 2. Meta-Conclusion (3 Groups)
                // Emotional: A, S | Energetic: R, E | Intellectual: I, C
                const metaScores = {
                    'Emotional': (audioEngine.activeGroups['A'] ? 1 : 0) + (audioEngine.activeGroups['S'] ? 1 : 0),
                    'Energetic': (audioEngine.activeGroups['R'] ? 1 : 0) + (audioEngine.activeGroups['E'] ? 1 : 0),
                    'Intellectual': (audioEngine.activeGroups['I'] ? 1 : 0) + (audioEngine.activeGroups['C'] ? 1 : 0)
                };

                // Determine Dominant Meta-Group
                let dominantMeta = Object.keys(metaScores).reduce((a, b) => metaScores[a] >= metaScores[b] ? a : b);

                // Conclusion Content Data - UPDATED DETAILED VERSION
                const conclusions = {
                    'Emotional': {
                        title: "Người Giàu Cảm Xúc & Thấu Cảm (The Empathizers)",
                        music: "Bản giao hưởng của bạn trôi chảy với những giai điệu du dương, mềm mại và giàu tính tượng hình. Sự kết hợp giữa các nhạc cụ thiên về không khí (như nhóm Nghệ thuật) và sự ấm áp (như nhóm Xã hội) tạo nên một không gian âm nhạc chữa lành, nơi cảm xúc được đặt lên hàng đầu hơn là kỹ thuật hay cường độ âm thanh.",
                        human: "Điều này phản chiếu bạn là người có chỉ số trí tuệ cảm xúc (EQ) cao, nhạy cảm và tinh tế. Thế giới nội tâm của bạn phong phú như một bản nhạc không lời đa tầng. Bạn lắng nghe người khác không chỉ bằng tai mà bằng cả trái tim, luôn tìm kiếm sự kết nối sâu sắc và ý nghĩa trong mọi mối quan hệ. Bạn thường là chỗ dựa tinh thần vững chắc cho những người xung quanh.",
                        advice: "Hãy trân trọng sự nhạy cảm của mình như một món quà. Tuy nhiên, đôi khi bạn cũng cần học cách thiết lập ranh giới cảm xúc để không bị ảnh hưởng quá nhiều bởi năng lượng tiêu cực từ bên ngoài."
                    },
                    'Energetic': {
                        title: "Người Tiên Phong & Năng Động (The Energetic Leaders)",
                        music: "Bản nhạc mang nhịp điệu dồn dập, mạnh mẽ và đầy uy lực. Tiếng trống giữ nhịp (nhóm Kỹ thuật) và kèn đồng vang dội (nhóm Quản lý) tạo nên những cú hích âm thanh dứt khoát, không có chỗ cho sự do dự. Đây là âm nhạc của hành động, của những bước tiến vững chãi và khải hoàn.",
                        human: "Bạn mang trong mình ngọn lửa nhiệt huyết của một nhà lãnh đạo thực thụ. Bạn thực tế, hướng ngoại và không ngại va chạm. Với bạn, cuộc sống là một sàn diễn nơi bạn phải luôn tiến về phía trước, chinh phục các mục tiêu bằng năng lượng tích cực và sự quyết đoán. Bạn thích nhìn thấy kết quả hữu hình hơn là những lý thuyết suông.",
                        advice: "Năng lượng của bạn là nguồn cảm hứng lớn. Hãy thử chậm lại một chút ở những đoạn nhạc nhẹ nhàng của cuộc sống để quan sát kỹ hơn những chi tiết nhỏ mà đôi khi tốc độ nhanh khiến bạn bỏ lỡ."
                    },
                    'Intellectual': {
                        title: "Người Tư Duy & Sáng Tạo Logic (The Intellectual Thinkers)",
                        music: "Tác phẩm của bạn là một cấu trúc chặt chẽ, lớp lang và đầy tính toán. Sự đan xen giữa các vòng lặp trật tự (nhóm Nghiệp vụ) và những giai điệu tìm tòi, phá cách (nhóm Nghiên cứu) tạo nên vẻ đẹp của trí tuệ—không ồn ào, phô trương nhưng cực kỳ thâm sâu và sắc sảo.",
                        human: "Bạn là mẫu người của tư duy độc lập và logic. Bạn nhìn thế giới qua lăng kính phân tích, luôn đặt câu hỏi 'Tại sao?' và 'Như thế nào?'. Bạn không dễ bị cuốn theo đám đông mà luôn giữ cho mình một cái đầu lạnh để quan sát và đúc kết những quy luật riêng. Sự sáng tạo của bạn không đến từ cảm hứng ngẫu nhiên mà từ nền tảng kiến thức vững chắc.",
                        advice: "Trí tuệ là sức mạnh lớn nhất của bạn. Đôi khi, hãy cho phép bản thân 'phi logic' một chút để tận hưởng những vẻ đẹp ngẫu hứng của cuộc sống mà không cần phải phân tích chúng."
                    }
                };

                const data = conclusions[dominantMeta];
                conclusionContent.innerHTML = `
                    <div style="text-align:center; font-family:'Pinyon Script', cursive; font-size:2rem; color:#d4af37; margin-bottom:20px; text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);">${data.title}</div>
                    
                    <span class="conclusion-label">Giai điệu phản chiếu:</span>
                    <p style="margin-bottom: 15px;">${data.music}</p>
                    
                    <span class="conclusion-label">Bản ngã con người:</span>
                    <p style="margin-bottom: 15px;">${data.human}</p>
                    
                    <span class="conclusion-label">Lời khuyên dành cho bạn:</span>
                    <p style="font-style: italic; color: #fff;">${data.advice}</p>
                `;
                conclusionDiv.style.display = 'block';

                document.getElementById('result-overlay').classList.add('active'); 
                document.body.classList.add('show-result');
            },
            replay: function() {
                document.getElementById('result-overlay').classList.remove('active'); 
                document.body.classList.remove('show-result');
            }
        };

        document.addEventListener('mousemove', (e) => {
            const x = e.clientX; const spotlight = document.getElementById('spotlight');
            const move = (x / window.innerWidth - 0.5) * 30; 
            spotlight.style.transform = `translateX(calc(-50% + ${move}%)) rotate(${move/2}deg)`;
        });
    </script>
</body>
</html>